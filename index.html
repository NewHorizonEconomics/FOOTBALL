<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FOOTBALL â€” ELO & Win% by UK Local Authority (1871â€“2025)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <!-- Leaflet + PapaParse (defer) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer crossorigin="anonymous"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
    :root { --bg:#0b0f19; --panel:#212F47; --text:#e8ecf3; --muted:#c3ccda; --accent:#4f8cff; --border:#2f3e5b; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    #app {
      display: grid;
      grid-template-columns: 360px 1fr;
      grid-template-rows: auto 1fr;
      height: 100%;
    }

    /* Header */
    header {
      grid-column: 1 / -1;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-weight: 800;
      font-size: 22px;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: var(--text);
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,.08); object-fit: cover; }
    .brand .sub { color: var(--muted); font-size: 12px; }

    /* Sidebar */
    aside {
      border-right: 1px solid var(--border);
      background: var(--panel);
      padding: 14px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Controls */
    .group { margin-bottom: 16px; }
    .group label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="range"],
    input[type="number"],
    button,
    select {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      background: #0e1424;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }
    .row-inline{display:flex;gap:8px;align-items:center}

    /* KPI */
    .kpis{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:8px}
    .kpi{background:#0e1424;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .kpi .l{font-size:12px;color:var(--muted);margin-bottom:4px}
    .kpi .v{font-size:18px;font-weight:700;color:var(--text)}

    /* Map & legend */
    main { position: relative; }
    #map { height: 100%; width: 100%; min-height: 400px; }
    .legend{position:absolute;bottom:16px;right:16px;background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.2;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:1000;pointer-events:none}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border-radius:2px;border:1px solid rgba(255,255,255,.1)}
    .tooltip{background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}

    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand">
        <img src="/data/logo.png" alt="logo" />
        <div>
          <h1>NEW HORIZON ECONOMICS | FOOTBALL â€” ELO & Win% by UK LOCAL AUTHORITY (1871â€“2025)</h1>
          <div class="sub">ONS LAD 2022 Â· interactive choropleth</div>
        </div>
      </div>
    </header>

    <aside>
      <div class="group kpis">
        <div class="kpi">
          <div class="l">Year</div>
          <div class="v" id="kpi-year">â€”</div>
        </div>
      </div>

      <div class="group">
        <label>Year</label>
        <input id="yearRange" type="range" min="1871" max="2025" step="1" value="1871"/>
        <input id="yearInput" type="number" min="1871" max="2025" step="1" value="1871" style="margin-top:6px;"/>
      </div>

      <div class="group">
        <label>Metric</label>
        <select id="metricMode">
          <option value="ELO" selected>ELO rating</option>
          <option value="WINPC_CALC">Win % (from WIN/PLAYED)</option>
        </select>
      </div>

      <div class="group row-inline">
        <button id="playBtn" style="flex:1;">â–¶ Play year</button>
        <button id="fitBtn" style="flex:1;">Reset map</button>
      </div>

      <div class="group">
        <button id="legendToggle" style="width:100%;">Hide legend</button>
      </div>

      <div class="group note">
        <strong>Reminder:</strong> To switch to 2023 boundaries later, change <code>GEO_URL</code> in the CONFIG section from <code>"lad_2022.geojson"</code> to <code>"lad_2023.geojson"</code>.
      </div>
    </aside>

    <main>
      <div id="map"></div>
      <div id="legend" class="legend"></div>
    </main>
  </div>

  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js" defer></script>
  <script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js" defer></script>

  <script defer>
// ============== CONFIG YOU CONTROL ==============
const CSV_URL   = 'wp-elo-lads.csv';     // YEAR, CODE (LAD22), NAME, ELO, WIN, PLAYED, WINPC
const GEO_URL   = 'lad_2022.geojson';    // ðŸ‘‰ change to 'lad_2023.geojson' when ready
const LAD_CODE_PROP = 'LAD22CD';         // code property in your LAD22 file
const LAD_NAME_PROP = 'LAD22NM';         // name property in your LAD22 file
// ================================================

// Blue palette, fixed across time, like Brewer Blues (lightâ†’dark)
const PALETTE = ['#eff6ff','#dbeafe','#bfdbfe','#93c5fd','#60a5fa','#3b82f6','#1d4ed8','#1e40af'];
const NO_DATA_FILL = '#3a4258';
const K = PALETTE.length - 1; // number of intervals between quantiles

let map, layer, geoLAD=null;
let rows=[], year=1871, yearBounds=[1871,2025], metric='ELO';
let legendVisible = JSON.parse(localStorage.getItem('legendVisible') ?? 'true');

// ---------- helpers ----------
const norm = x => String(x??'').trim().toUpperCase();
function num(x){ if(x==null) return NaN; const s=String(x).replace(/[\s,]+/g,'').replace(/[âˆ’â€“â€”]/g,'-'); const v=+s; return Number.isFinite(v)?v:NaN; }
function quantiles(values, k){
  const v = values.filter(Number.isFinite).sort((a,b)=>a-b);
  if(!v.length) return [];
  const qs=[]; for(let i=0;i<=k;i++){ const p=i/k; const idx=Math.floor(p*(v.length-1)); qs.push(v[idx]); }
  return qs;
}
function colorFor(val, breaks){
  if(!Number.isFinite(val) || !breaks.length) return NO_DATA_FILL;
  for(let i=0;i<K;i++){ if(val <= breaks[i+1]) return PALETTE[i+0]; } // i+0 keeps alignment with breaks
  return PALETTE[PALETTE.length-1];
}
function fmtMetric(m,v){
  if(!Number.isFinite(v)) return 'â€”';
  return m==='ELO' ? v.toFixed(2) : v.toFixed(1) + '%';
}
function metricLabel(m){
  return m==='ELO' ? 'ELO rating' : 'Win % (from WIN/PLAYED)';
}

// --- Reproject EPSG:27700 (OSGB36 / BNG) GeoJSON -> WGS84 ---
const EPSG27700_DEF =
  '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 ' +
  '+ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';
function firstXY(coords){ if(!coords) return null; if(typeof coords[0]==='number') return coords; for(const c of coords){ const v=firstXY(c); if(v) return v; } return null; }
function isLikelyBNG(geo){ try{ const xy=firstXY(geo?.features?.[0]?.geometry?.coordinates); if(!xy) return false; const [x,y]=xy; return Math.abs(x)>180 || Math.abs(y)>90; }catch{return false;} }
function reproject27700toWGS84(geo){
  if(!window.proj4) return geo;
  proj4.defs('EPSG:27700', EPSG27700_DEF);
  const fwd = (xy) => proj4('EPSG:27700','WGS84', xy);
  function rp(coords){ if(typeof coords[0]==='number'){ const [x,y]=coords; const [lon,lat]=fwd([x,y]); return [lon,lat]; } return coords.map(rp); }
  const out = JSON.parse(JSON.stringify(geo));
  for(const f of out.features){ if(f.geometry?.coordinates) f.geometry.coordinates = rp(f.geometry.coordinates); }
  return out;
}

// ----------------- app bootstrap -----------------
window.addEventListener('DOMContentLoaded', async ()=>{
  map = L.map('map',{preferCanvas:true,zoomSnap:0.25,zoomDelta:0.5}).setView([54.9,-3.5],6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
              {attribution:'&copy; OpenStreetMap, &copy; CARTO'}).addTo(map);

  // Hook controls
  const yrR=document.getElementById('yearRange'), yrI=document.getElementById('yearInput');
  yrR.addEventListener('input',e=>{year=+e.target.value; yrI.value=year; render();});
  yrI.addEventListener('input',e=>{year=+e.target.value; yrR.value=year; render();});
  document.getElementById('metricMode').addEventListener('change', e=>{ metric=e.target.value; render(true); });
  document.getElementById('fitBtn').addEventListener('click', fitUK);
  document.getElementById('playBtn').addEventListener('click', togglePlay);

  const legendBtn = document.getElementById('legendToggle');
  if (legendBtn) {
    legendBtn.addEventListener('click', () => {
      legendVisible = !legendVisible;
      applyLegendVisibility();
    });
  }

  try{
    await loadAll();
    computeBreaks();   // fixed bins across full period for each metric
    buildLayer();
    fitUK();
    render();
    applyLegendVisibility();
  }catch(err){
    console.error(err);
    alert('Failed to load one or more resources â€” check the console for details.');
  }
});

// ------------------- loading ---------------------
async function loadAll(){
  // CSV
  const res = await fetch(CSV_URL, {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed');
  const text = await res.text();
  const parsed = Papa.parse(text, {header:true, dynamicTyping:false, skipEmptyLines:true});
  const raw = parsed.data || [];
  if(!raw.length) throw new Error('CSV parsed with 0 rows');

  // Normalise & coerce
  rows = raw.map(r => ({
    code: norm(r.CODE),
    year: +r.YEAR,
    name: String(r.NAME ?? ''),
    elo:  num(r.ELO),
    win:  num(r.WIN),
    played: num(r.PLAYED)
  })).filter(r => Number.isFinite(r.year) && r.code);

  // Year bounds from data
  const yrs = [...new Set(rows.map(r => r.year))].filter(Number.isFinite).sort((a,b)=>a-b);
  if(yrs.length){ yearBounds=[yrs[0], yrs[yrs.length-1]]; }
  year = Math.max(Math.min(year, yearBounds[1]), yearBounds[0]);
  document.getElementById('yearRange').min = yearBounds[0];
  document.getElementById('yearRange').max = yearBounds[1];
  document.getElementById('yearRange').value = year;
  document.getElementById('yearInput').min = yearBounds[0];
  document.getElementById('yearInput').max = yearBounds[1];
  document.getElementById('yearInput').value = year;

  // GeoJSON
  const gj = await fetch(GEO_URL, {cache:'no-store'});
  if(!gj.ok) throw new Error('LAD geo fetch failed');
  let rawGeo = await gj.json();
  geoLAD = isLikelyBNG(rawGeo) ? reproject27700toWGS84(rawGeo) : rawGeo;
}

// Aggregate per (year, code):
// - ELO: mean of available ELOs (prepping for future multi-team aggregation)
// - WINPC_CALC: (sum WIN) / (sum PLAYED) * 100
function aggByYearCode(){
  const out = new Map(); // key: `${year}__${code}`
  for(const r of rows){
    const key = r.year + '__' + r.code;
    if(!out.has(key)) out.set(key, {year:r.year, code:r.code, name:r.name, eloVals:[], winSum:0, playedSum:0});
    const a = out.get(key);
    if(Number.isFinite(r.elo)) a.eloVals.push(r.elo);
    if(Number.isFinite(r.win)) a.winSum += r.win;
    if(Number.isFinite(r.played)) a.playedSum += r.played;
  }
  const out2 = new Map();
  for(const [k,a] of out.entries()){
    const elo = a.eloVals.length ? (a.eloVals.reduce((x,y)=>x+y,0)/a.eloVals.length) : NaN;
    const winpc = a.playedSum>0 ? (a.winSum / a.playedSum) * 100 : NaN;
    out2.set(k, {year:a.year, code:a.code, name:a.name, ELO: elo, WINPC_CALC: winpc, WIN:a.winSum, PLAYED:a.playedSum});
  }
  return out2;
}

let AGG=null;
let BREAKS={ ELO:[], WINPC_CALC:[] };

function computeBreaks(){
  AGG = aggByYearCode();
  const years = [...new Set(rows.map(r=>r.year))].filter(Number.isFinite);
  const vals = {ELO:[], WINPC_CALC:[]};

  for(const y of years){
    for(const [k,rec] of AGG.entries()){
      if(rec.year !== y) continue;
      if(Number.isFinite(rec.ELO)) vals.ELO.push(rec.ELO);
      if(Number.isFinite(rec.WINPC_CALC)) vals.WINPC_CALC.push(rec.WINPC_CALC);
    }
  }
  BREAKS.ELO = quantiles(vals.ELO, K);
  BREAKS.WINPC_CALC = quantiles(vals.WINPC_CALC, K);
}

function buildLayer(){
  if(layer) { map.removeLayer(layer); layer=null; }
  layer = L.geoJSON(geoLAD, {
    style: baseStyle,
    onEachFeature: (f,l)=> bindFeature(f,l,LAD_CODE_PROP,LAD_NAME_PROP)
  }).addTo(map);
}

function baseStyle(){ return { color:'#9fb6e6', weight:1.1, fillColor:NO_DATA_FILL, fillOpacity:0.9 }; }

function bindFeature(f, l, codeProp, nameProp){
  l.on({
    mouseover:e=>{ e.target.setStyle({weight:2,color:'#fff',fillColor:e.target._currentFill,fillOpacity:1}); },
    mouseout:e=>{ e.target.setStyle({weight:1.1,color:'#9fb6e6',fillColor:e.target._currentFill,fillOpacity:0.9}); },
    click:()=> map.fitBounds(l.getBounds(), {maxZoom:9})
  });
  l._codeProp = codeProp; l._nameProp = nameProp;
}

function applyLegendVisibility() {
  const legend = document.getElementById('legend');
  const btn = document.getElementById('legendToggle');
  if (!legend) return;
  legend.style.display = legendVisible ? 'block' : 'none';
  if (btn) btn.textContent = legendVisible ? 'Hide legend' : 'Show legend';
  localStorage.setItem('legendVisible', JSON.stringify(legendVisible));
}

function fmt(x, m){
  if(!Number.isFinite(x)) return 'â€”';
  return m==='ELO' ? x.toFixed(0) : x.toFixed(0) + '%';
}

function updateLegend(){
  const el = document.getElementById('legend');
  const breaks = BREAKS[metric] || [];
  let html = `
    <div style="margin-bottom:6px;font-weight:700;text-transform:uppercase;line-height:1.25">
      ${metricLabel(metric)}<br/>
      <span style="font-weight:400;color:var(--muted)">
        LAD Â· fixed scale ${yearBounds[0]}â€“${yearBounds[1]}
      </span>
    </div>
  `;
  if(!breaks.length){
    html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
    el.innerHTML = html; applyLegendVisibility(); return;
  }
  for(let i=0;i<K;i++){
    const a = breaks[i], b = breaks[i+1];
    if(a==null || b==null) continue;
    html += `<div class="row"><span class="swatch" style="background:${PALETTE[i]}"></span> ${fmt(a,metric)} â€“ ${fmt(b,metric)}</div>`;
  }
  html += `<div class="row"><span class="swatch" style="background:${PALETTE[PALETTE.length-1]}"></span> > ${fmt(breaks[K],metric)}</div>`;
  html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
  el.innerHTML = html;
  applyLegendVisibility();
}

function render(rebuildBreaks=false){
  if(!layer) return;
  if(rebuildBreaks) updateLegend(); // metric change: legend rebuilt anyway
  document.getElementById('kpi-year').textContent = year;

  const breaks = BREAKS[metric] || [];
  let matched=0, total=0;

  layer.eachLayer(l=>{
    total++;
    const f=l.feature;
    const code = norm(f.properties[l._codeProp]);
    const name = String(f.properties[l._nameProp]||'');

    const rec = AGG.get(year + '__' + code);
    let val = NaN, elo=null, win=null, played=null, winpc=null;
    if(rec){
      val = rec[metric];
      elo = rec.ELO;
      win = rec.WIN;
      played = rec.PLAYED;
      winpc = rec.WINPC_CALC;
    }
    const fill = colorFor(val, breaks); l._currentFill = fill; l.setStyle({fillColor:fill});

    const valTxt = fmtMetric(metric, val);
    const eloTxt = Number.isFinite(elo) ? elo.toFixed(2) : 'â€”';
    const wpTxt = Number.isFinite(winpc) ? winpc.toFixed(1)+'%' : 'â€”';
    const wonPlayed = (Number.isFinite(win) || Number.isFinite(played)) ? `${Number.isFinite(win)?win:'â€”'} / ${Number.isFinite(played)?played:'â€”'}` : 'â€”';

    l.bindTooltip(`<div><strong>${name}</strong><br/><span class="note">${code}</span><br/><strong>${metricLabel(metric)}:</strong> ${valTxt}<br/>ELO: ${eloTxt}<br/>Won/Played: ${wonPlayed} (${wpTxt})</div>`,
      {sticky:true, opacity:0.95, className:'tooltip'});

    if(Number.isFinite(val)) matched++;
  });

  updateLegend();
  console.log(\`Render LAD/\${metric} \${year}: matched \${matched} of \${total}\`);
}

function fitUK(){ if(!layer) return; const tight = layer.getBounds().pad(-0.05); map.fitBounds(tight, {padding:[20,20]}); }
let timer=null;
function togglePlay(){
  const btn=document.getElementById('playBtn');
  if(timer){ clearInterval(timer); timer=null; btn.textContent='â–¶ Play year'; return; }
  btn.textContent='â¸ Pause';
  const [minY,maxY]=yearBounds;
  timer=setInterval(()=>{
    year = (year>=maxY)?minY:(year+1);
    document.getElementById('yearRange').value=year;
    document.getElementById('yearInput').value=year;
    render();
  }, 900);
}
  </script>
</body>
</html>
